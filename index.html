<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <title>Spindle.io</title>
        <meta name="description" content="Spindle.io is the easiest way to connect with random strangers across the world.">
        <meta name="viewport" content="width=device-width">
        
        <script type="text/javascript" src="//use.typekit.net/qpk6qlw.js"></script>
        <script type="text/javascript">try{Typekit.load();}catch(e){ }</script>
        <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
        <script src="http://static.opentok.com/webrtc/v2.0/js/TB.min.js" type="text/javascript"></script>
        <style type="text/css">
            body { background-image: url('bg.png'); font-family: sans-serif; width: 100%; height: 100%; margin: 0; padding: 0; }
            div#background { width: 100%; height: 100%; position: absolute; background-color: rgba(0, 0, 0, .75); margin-top: -50px; padding-bottom: 15px; }
            div#container { width: 980px; margin: 0 auto; }
            div#incompatible { background-color: rgba(217, 98, 98, .75); border-bottom: 1px solid #333; text-align: center; padding: 10px 0; color: #333; }

            h1 { font-size: 56px; }
            
            div#allow-cam .arrow_box {
                margin-top: -8px;
                margin-left: 265px;
                color: rgb(255, 255, 255);
                text-shadow: -0.05em -0.05em rgb(200, 200, 200);
                font-family: 'Lobster', cursive;
                font-size: 34px;
                padding: 15px 10px;
                position: fixed;
                background: #82d55e;
                width: 350px;
                text-align: center;
            }

            div#allow-cam .arrow_box:after, .arrow_box:before {
                bottom: 100%;
                border: solid transparent;
                content: " ";
                height: 0;
                width: 0;
                position: absolute;
                pointer-events: none;
            }

            div#allow-cam .arrow_box:after {
                border-color: rgba(130, 213, 94, 0);
                border-bottom-color: #82d55e;
                border-width: 30px;
                left: 50%;
                margin-left: -30px;
            }

            .hidden { display: none; }
    </style>
    </head>
    <body>
        <div id="background"></div>
        <div id="incompatible" class="top-bar hidden">Sorry your browser is currently not supported. Please download <a href="//google.com/chrome">Chrome</a> to use ChatToky</div>
        <div id="allow-cam" class="top-bar hidden"><div class="arrow_box">Click allow to start chatting!</div></div>

        <div id="container">
            <h1 class="tk-museo-slab">Spindle.io</h1>
            <video id="video" width="480" height="320" autoplay></video>
        </div>


        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script type="text/javascript">
          if ( !!(navigator.userAgent.match(/Chrome\/24|Chrome\/23/gi)) ) {
            
            $("div#allow-cam").hide().removeClass('hidden').show();
          } else { $("div#incompatible").removeClass('hidden'); }

          // Put event listeners into place
          window.addEventListener("DOMContentLoaded", function() {
            var video = document.getElementById("video"), videoObj = { "video": true };
            
            navigator.webkitGetUserMedia(videoObj, function(stream){ 
              
              $("div#allow-cam").hide();
              $("div#background").hide();
              
              // start streaming video to display
              video.src = window.webkitURL.createObjectURL(stream); 
              video.play();

              var session_id = '';

              // make request for session_id
              $.ajax({
                url: "/",
                type: "POST",
                data: { session_id: session_id },
                dataType: 'json',
                success: function(data){ 
                    var apiKey = "22766332";
                    var sessionID = data['session_id'];
                    var token = data['token'];

                    var session = TB.initSession(sessionID);
                    session.addEventListener("sessionConnected", sessionConnectHandler);
                    session.connect(apiKey, token);

                    function sessionConnectHandler(event) {
                        for (var i = 0; i < event.streams.length; i++) {
                            var stream = event.streams[i];
                            displayStream(stream);
                        }
                    }

                    function displayStream(stream) {
                        var div = document.createElement('div');
                        div.setAttribute('id', 'stream' + stream.streamId);
                        var streamsContainer = document.getElementById('streamsContainer');
                        streamsContainer.appendChild(div);
                        subscriber = session.subscribe(stream, 'stream' + stream.streamId);
                    }
                },
                error: function() { alert("There has been an error.") }
              });
              
            });
          }, false);

        </script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>